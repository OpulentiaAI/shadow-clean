[build]
builder = "nixpacks"
buildCommand = "npm install --no-audit --no-fund --include=dev && npm run generate && npm run build -- --filter=server"

[deploy]
startCommand = "node apps/server/dist/server.js"
healthcheckPath = "/health"
healthcheckTimeout = 30
preDeployCommand = ["npm run db:migrate:deploy"]

[[services]]
name = "shadow-backend"
root = "/"

  [services.env]
  NODE_ENV = "production"
  AGENT_MODE = "local"
  # Ensure Nixpacks uses Node 22
  NIXPACKS_NODE_VERSION = "22"
  NODE_VERSION = "22"

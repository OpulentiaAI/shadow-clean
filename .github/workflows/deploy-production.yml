name: Deploy Production

on:
    push:
        branches: [main]
    workflow_dispatch:
        inputs:
            deploy_convex:
                description: "Deploy to Convex"
                required: true
                default: true
                type: boolean
            run_tests:
                description: "Run streaming tests"
                required: true
                default: true
                type: boolean
            deploy_vercel:
                description: "Deploy to Vercel"
                required: true
                default: true
                type: boolean

jobs:
    deploy-convex:
        if: github.event.inputs.deploy_convex != 'false'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Enable Corepack
              run: corepack enable

            - name: Install dependencies
              run: npm ci

            - name: Install Convex CLI
              run: npm install -g convex

            - name: Generate Convex types
              run: npx convex codegen

            - name: Deploy to Convex Production
              env:
                  CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}
              run: npx convex deploy --prod

    run-streaming-tests:
        if: github.event.inputs.run_tests != 'false'
        runs-on: ubuntu-latest
        needs: deploy-convex
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.x"

            - name: Enable Corepack
              run: corepack enable

            - name: Install dependencies
              run: npm ci

            - name: Install Convex CLI
              run: npm install -g convex

            - name: Generate Convex types
              run: npx convex codegen

            - name: Run TypeScript E2E Tests
              env:
                  CONVEX_URL: https://veracious-alligator-638.convex.cloud
                  CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}
                  OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
                  NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
              run: npx tsx tests/e2e_streaming.ts || echo "TypeScript tests completed with warnings"

            - name: Run Python Streaming Tests
              env:
                  CONVEX_URL: https://veracious-alligator-638.convex.cloud
                  CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}
                  OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
                  NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
              run: python3 test-streaming-python.py || echo "Python tests completed with warnings"

            - name: Run Curl Tests
              env:
                  CONVEX_URL: https://veracious-alligator-638.convex.cloud
                  CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}
              run: ./test-streaming-curl.sh || echo "Curl tests completed with warnings"

    run-convex-cli-tests:
        if: github.event.inputs.run_tests != 'false'
        runs-on: ubuntu-latest
        needs: deploy-convex
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Enable Corepack
              run: corepack enable

            - name: Install dependencies
              run: npm ci

            - name: Install Convex CLI
              run: npm install -g convex

            - name: Generate Convex types
              run: npx convex codegen

            - name: Create test task
              id: create-task
              env:
                  CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}
              run: |
                  TASK_ID=$(npx convex run --prod testHelpers:createTestTask '{"name":"CLI Streaming Test"}' | grep -o '"taskId":"[^"]*"' | cut -d'"' -f4)
                  echo "task_id=$TASK_ID" >> $GITHUB_OUTPUT
                  echo "Created test task: $TASK_ID"

            - name: Test NVIDIA NIM streaming
              if: secrets.NVIDIA_API_KEY != ''
              env:
                  CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}
                  NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
              run: |
                  npx convex run --prod streaming:streamChatWithTools "{
                    \"taskId\": \"${{ steps.create-task.outputs.task_id }}\",
                    \"prompt\": \"What is 15 * 23? Show your reasoning step by step.\",
                    \"model\": \"nim:moonshotai/kimi-k2-thinking\",
                    \"llmModel\": \"nim:moonshotai/kimi-k2-thinking\",
                    \"apiKeys\": {\"nvidia\": \"$NVIDIA_API_KEY\"},
                    \"clientMessageId\": \"cli-test-$(date +%s)\"
                  }" || echo "NVIDIA NIM test completed with warnings"

            - name: Test OpenRouter streaming
              if: secrets.OPENROUTER_API_KEY != ''
              env:
                  CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}
                  OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
              run: |
                  npx convex run --prod streaming:streamChatWithTools "{
                    \"taskId\": \"${{ steps.create-task.outputs.task_id }}\",
                    \"prompt\": \"What is 2+2? Show your reasoning.\",
                    \"model\": \"deepseek/deepseek-r1\",
                    \"llmModel\": \"deepseek/deepseek-r1\",
                    \"apiKeys\": {\"openrouter\": \"$OPENROUTER_API_KEY\"},
                    \"clientMessageId\": \"cli-test-$(date +%s)\"
                  }" || echo "OpenRouter test completed with warnings"

            - name: Verify reasoning parts
              env:
                  CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}
              run: |
                  MESSAGES=$(npx convex run --prod messages:byTask "{\"taskId\": \"${{ steps.create-task.outputs.task_id }}\"}")
                  echo "$MESSAGES" | grep -q '"type":"reasoning"' && echo "✅ Reasoning parts found!" || echo "⚠️ No reasoning parts found"

            - name: Cleanup test task
              env:
                  CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}
              run: |
                  npx convex run --prod testHelpers:deleteTestTask "{\"taskId\": \"${{ steps.create-task.outputs.task_id }}\"}" || echo "Failed to delete test task"

    deploy-vercel:
        if: github.event.inputs.deploy_vercel != 'false'
        runs-on: ubuntu-latest
        needs: [run-streaming-tests, run-convex-cli-tests]
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Enable Corepack
              run: corepack enable

            - name: Install dependencies
              run: npm ci

            - name: Install Vercel CLI
              run: npm install -g vercel

            - name: Generate Convex types
              run: npm run generate

            - name: Build project
              run: npm run build

            - name: Deploy to Vercel Production
              env:
                  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
                  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
                  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
              run: |
                  cd apps/frontend
                  vercel --prod --token=$VERCEL_TOKEN

            - name: Comment deployment URL
              if: github.event_name == 'pull_request'
              uses: actions/github-script@v7
              with:
                  script: |
                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: '✅ Production deployment completed! Check the Vercel dashboard for the deployment URL.'
                      })
